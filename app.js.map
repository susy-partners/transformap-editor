{"version":3,"sources":["app/initialize.js","app/lib/editor.js","app/lib/getUrlVars.js","app/lib/map.js","app/lib/red_fetch.js","app/lib/taxonomy.js","app/lib/translations.js"],"names":["editor","require","document","addEventListener","console","log","initMap","getUrlVars","redFetch","taxonomy","translations","window","map","endpoint","module","exports","urlVars","dataUrls","place","test","normalizedPlace","replace","length","createToiArray","toiString","toiArray","split","i","trim","startLang","selectAllowedLang","current_lang","supported_languages","typeOfInintiatives","toiHashtable","fillTOIs","data","$","empty","toiSelect","getElementById","dataArray","results","bindings","itemLabel","forEach","entry","type_of_initiative_tag","value","label","currentObject","item","push","labelCompare","a","b","match","sort","newOption","createElement","optionValue","createAttribute","setAttributeNode","currentData","properties","type_of_initiative","tois","toi","newSelected","createTextNode","appendChild","selectpicker","addFreeTagsRow","freetags","lastRow","lastChild","nodeType","previousSibling","keyNode","firstChild","nextSibling","newNr","parseInt","id","slice","newRow","divClass","newKey","bootstrapClass","newValue","keyId","valueId","elementName","cloneNode","fillForm","placeData","_deleted","style","display","key","field","valueNode","geometry","coordinates","lon","lat","undefined","error","my_current_marker","L","marker","icon","my_placeMarker","my_editableLayers","addLayer","my_drawControl","getDrawControl","addControl","panTo","LatLng","_id","e","menu","append","initializeTranslatedTOIs","Q5data","initializeLanguageSwitcher","nowPossibleLang","fetchAndSetNewTranslation","lang","getLangTaxURL","createCORSRequest","method","url","xhr","XMLHttpRequest","open","XDomainRequest","clickSubmit","requiredFields","alert","parseFloat","allInputs","getElementsByTagName","freeTags","keys","values","element","type","name","nr","keynr","allSelects","childCounter","children","child","selected","allTextareas","uuid","sendData","JSON","stringify","setRequestHeader","send","onreadystatechange","readyState","status","retJson","parse","responseText","onclick","clickDelete","confirm","clickSearch","country","city","street","housenumber","querystring","query","successData","result","class","focus","setView","setTimeout","stopRKey","evt","event","node","target","srcElement","keyCode","onkeypress","updateLinkPosition","centre","getCenter","targetlocation","getZoom","lng","maplink","href","getAttribute","splitstr","setAttribute","newlink","on","vars","parts","location","m","L_Hash","L_Draw","editableLayers","drawControl","placeMarker","popupText","allowNewMarker","markerValue","options","position","draw","polyline","polygon","rectangle","circle","edit","featureGroup","remove","Control","Draw","attrOsm","attrPois","leafletBgMaps","zoom","defaultlayer","center","baseMaps","tileLayer","attribution","maxZoom","noWrap","zoomControl","layers","ctrl","Layers","hash","Hash","FeatureGroup","Icon","extend","shadowUrl","iconAnchor","Point","iconSize","iconUrl","Event","CREATED","layerType","layer","bindPopup","_latlng","toFixed","removeControl","updateMarkerFromForm","coords","latLng","setLatLng","onblur","processStatus","response","Promise","resolve","reject","Error","statusText","parseJson","json","getWrappedPromise","wrappedPromise","promise","then","bind","catch","getWrappedFetch","args","Array","prototype","call","arguments","fetch","apply","MAX_WAITING_TIME","getJSON","params","wrappedFetch","cacheBusting","Date","getTime","headers","timeoutId","clearTimeout","myGetJSON","successFunction","errorFunction","getJSONparams","redundantFetch","dataUrlArray","constructor","currentUrl","shift","localErrorFunction","localSuccessFunction","tax_query","encodeURIComponent","getLangs","language","navigator","languages","userLanguage","short_lang","indexOf","setFallbackLangs","fallback_langs","browser_languages","abbr","join","resetLang","abbr_langnames","switchToLang","langnames","langnames_abbr","returned_data","entities","Q5","labels","langstr","langstr_query","langstrings","langLabel","langcode","is_default","removeClass","addClass","wishedLang","matches"],"mappings":"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","file":"public/app.js","sourcesContent":["const editor = require('lib/editor')\n\ndocument.addEventListener('DOMContentLoaded', () => {\n  // do your setup here\n  editor()\n  console.log('Initialized app')\n})\n","/* global alert, L, XMLHttpRequest, XDomainRequest */ // used by standardjs (linter)\n\nconst initMap = require('./map.js')\nconst getUrlVars = require('./getUrlVars.js')\nconst redFetch = require('./red_fetch.js')\nconst taxonomy = require('./taxonomy.js')\nconst translations = require('./translations.js')\nwindow.translations = translations\n\nvar map\nconst endpoint = 'https://data.transformap.co/place/'\n\nmodule.exports = function () {\n  console.log('editor initialize start')\n\n  map = initMap()\n\n  var urlVars = getUrlVars()\n  var dataUrls\n  const place = urlVars['place']\n  if (place) {\n    if (/^[0-9a-f-]{32,36}$/i.test(place)) {\n      const normalizedPlace = place.replace(/-/, '')\n      if (normalizedPlace.length === 32) {\n        dataUrls = [ endpoint + place, 'http://192.168.0.2:6000/place/' + place, place ]\n      } else {\n        dataUrls = [ place ]\n      }\n    } else {\n      dataUrls = [ place ]\n    }\n  }\n\n  function createToiArray (toiString) {\n    if (typeof (toiString) !== 'string') { return [] }\n    var toiArray = toiString.split(';')\n    for (var i = 0; i < toiArray.length; i++) {\n      toiArray[i] = toiArray[i].trim()\n    }\n    return toiArray\n  }\n\n  var startLang = translations.selectAllowedLang(translations.current_lang)\n  console.log(\"lang on start: \" + startLang)\n  console.log(translations.supported_languages)\n  var typeOfInintiatives = []\n  var toiHashtable = {}\n\n  function fillTOIs (data) {\n    $('#_key_type_of_initiative').empty()\n\n    typeOfInintiatives = []\n    toiHashtable = {}\n\n    var toiSelect = document.getElementById('_key_type_of_initiative')\n    var dataArray = data.results.bindings\n    const current_lang = dataArray[0].itemLabel['xml:lang']\n    dataArray.forEach(function (entry) {\n      if (!entry.type_of_initiative_tag) {\n        return\n      }\n      if (toiHashtable[entry.type_of_initiative_tag.value]) { // filter out duplicates\n        return\n      }\n      var label = {}\n      label[current_lang] = entry.itemLabel.value\n\n      var currentObject = {\n        item: entry.item.value,\n        label: label,\n        type_of_initiative_tag: entry.type_of_initiative_tag.value\n      }\n      typeOfInintiatives.push(currentObject)\n      toiHashtable[entry.type_of_initiative_tag.value] = currentObject\n    })\n    function labelCompare (a, b) {\n      // 'Others' cat should get sorted last\n      if (a.item === 'https://base.transformap.co/entity/Q20') return 1\n      if (b.item === 'https://base.transformap.co/entity/Q20') return -1\n\n      // in toi list, 'other*' should be last\n      if (a.type_of_initiative_tag && a.type_of_initiative_tag.match(/^other_/)) return 1\n      if (b.type_of_initiative_tag && b.type_of_initiative_tag.match(/^other_/)) return -1\n\n      if (a.label[current_lang] < b.label[current_lang]) {\n        return -1\n      } else {\n        return 1\n      }\n    }\n    typeOfInintiatives.sort(labelCompare)\n\n    typeOfInintiatives.forEach(function (entry) {\n      var newOption = document.createElement('option')\n      var optionValue = document.createAttribute('value')\n      optionValue.value = entry.type_of_initiative_tag\n      newOption.setAttributeNode(optionValue)\n\n      if (currentData.properties && currentData.properties.type_of_initiative) {\n        var tois = createToiArray(currentData.properties.type_of_initiative)\n        tois.forEach(function (toi) {\n          if (toi === entry.type_of_initiative_tag) {\n            var newSelected = document.createAttribute('selected')\n            newOption.setAttributeNode(newSelected)\n          }\n        })\n      }\n\n      var label = document.createTextNode(entry.label[current_lang]) // FIXME fallback langs\n      newOption.appendChild(label)\n\n      toiSelect.appendChild(newOption)\n      $('#_key_type_of_initiative').selectpicker('refresh')\n    })\n  }\n\n  function addFreeTagsRow () {\n    var freetags = document.getElementById('freetags')\n\n    var lastRow = freetags.lastChild\n    while (lastRow.nodeType === 3) { // 3 = text-node\n      lastRow = lastRow.previousSibling\n    }\n\n    var keyNode = (lastRow.firstChild.nodeType === 1) ? lastRow.firstChild : lastRow.firstChild.nextSibling\n    var newNr = parseInt(keyNode.id.slice(-1)) + 1\n\n    var newRow = document.createElement('div')\n    var divClass = document.createAttribute('class')\n    divClass.value = 'row'\n    newRow.setAttributeNode(divClass)\n    var newKey = document.createElement('input')\n    var bootstrapClass = document.createAttribute('class')\n    bootstrapClass.value = 'form-control';\n    newKey.setAttributeNode(bootstrapClass);\n    var bootstrapClass = document.createAttribute('class')\n    bootstrapClass.value = 'form-control';\n    var newValue = document.createElement('input')\n    newValue.setAttributeNode(bootstrapClass);\n    var keyId = document.createAttribute('id')\n    keyId.value = 'key' + newNr\n    var valueId = document.createAttribute('id')\n    valueId.value = 'value' + newNr\n    newKey.setAttributeNode(keyId)\n    newValue.setAttributeNode(valueId)\n\n    var elementName = document.createAttribute('name')\n    elementName.value = 'freetags'\n    newKey.setAttributeNode(elementName)\n    newValue.setAttributeNode(elementName.cloneNode(true))\n\n    newRow.appendChild(newKey)\n    newRow.appendChild(newValue)\n    freetags.appendChild(newRow)\n  }\n\n  var currentData = {}\n\n  function fillForm (placeData) {\n    currentData = placeData\n\n    if (currentData._deleted) {\n      document.getElementById('deleted').style.display = 'block'\n    }\n\n    if (currentData.properties) {\n      for (var key in currentData.properties) {\n        // ignore DB-generated fields\n        if (/^_/.test(key)) {\n          continue\n        }\n\n        var field = document.getElementById('_key_' + key)\n        var value = currentData.properties[key]\n\n        if (field) {\n          // console.log(field)\n          // console.log(value)\n          field.value = value\n        } else { // put it into \"free tags\"\n          // get last child\n          var freetags = document.getElementById('freetags')\n          var lastRow = freetags.lastChild\n          while (lastRow.nodeType === 3) { // 3 = text-node\n            lastRow = lastRow.previousSibling\n          }\n\n          // set data on last child\n          var keyNode = (lastRow.firstChild.nodeType === 1) ? lastRow.firstChild : lastRow.firstChild.nextSibling\n          keyNode.value = key\n          var valueNode = (lastRow.lastChild.nodeType === 1) ? lastRow.lastChild : lastRow.lastChild.previousSibling\n          valueNode.value = value\n\n          addFreeTagsRow()\n        }\n      }\n    }\n    if (currentData.geometry && currentData.geometry.coordinates) {\n      var lon = currentData.geometry.coordinates[0]\n      var lat = currentData.geometry.coordinates[1]\n      if (lat === undefined || lon === undefined) {\n        console.error('lat or lon empty')\n        return\n      }\n\n      document.getElementById('_geometry_lon').value = lon\n      document.getElementById('_geometry_lat').value = lat\n\n      map.my_current_marker = new L.marker([lat, lon], { icon: new map.my_placeMarker() })\n      map.my_editableLayers.addLayer(map.my_current_marker)\n\n      map.my_drawControl = map.getDrawControl(false)\n      map.addControl(map.my_drawControl)\n\n      map.panTo(new L.LatLng(lat, lon))\n    } else { // allow adding a marker\n      map.my_drawControl = map.getDrawControl(true)\n      map.addControl(map.my_drawControl)\n    }\n    if (currentData.properties && currentData.properties._id) {\n      document.getElementById('_id').value = currentData.properties._id\n    } else if (currentData._id) {\n      document.getElementById('_id').value = currentData._id\n    }\n  }\n\n  if (place) {\n    redFetch(dataUrls, fillForm, function (e) {\n      console.error(e)\n      map.my_drawControl = map.getDrawControl(true)\n      map.addControl(map.my_drawControl)\n    })\n  } else {\n    map.my_drawControl = map.getDrawControl(true)\n    map.addControl(map.my_drawControl)\n  }\n\n  //add languageswitcher\n  var menu = document.getElementById('menu')\n  $('#menu').append(\n      '<div id=languageSelector onClick=\"$(\\'#languageSelector ul\\').toggleClass(\\'open\\');\">' +\n        '<span lang=en>Choose Language:</span>' +\n        '<ul></ul>' +\n      '</div>')\n\n  function initializeTranslatedTOIs(Q5data) {\n    translations.initializeLanguageSwitcher(Q5data)\n    \n    var nowPossibleLang = translations.selectAllowedLang(translations.current_lang)\n    translations.current_lang = nowPossibleLang\n    fetchAndSetNewTranslation(nowPossibleLang)\n  }\n\n  function fetchAndSetNewTranslation(lang) {\n    redFetch([ taxonomy.getLangTaxURL(lang), 'https://raw.githubusercontent.com/TransforMap/transformap-viewer-translations/master/taxonomy-backup/susy/taxonomy.' + lang + '.json' ],\n        fillTOIs,\n        function (error) { console.error('none of the taxonomy data urls available') })\n  }\n  translations.fetchAndSetNewTranslation = fetchAndSetNewTranslation\n\n  redFetch( [ \"https://base.transformap.co/wiki/Special:EntityData/Q5.json\", \"https://raw.githubusercontent.com/TransforMap/transformap-viewer/Q5-fallback.json\" ],\n    initializeTranslatedTOIs,\n    function(error) { console.error(\"none of the lang init data urls available\") } );\n\n\n  function createCORSRequest (method, url) {\n    // taken from https://www.html5rocks.com/en/tutorials/cors/\n    var xhr = new XMLHttpRequest()\n    if ('withCredentials' in xhr) {\n      // Check if the XMLHttpRequest object has a \"withCredentials\" property.\n      // \"withCredentials\" only exists on XMLHTTPRequest2 objects.\n      xhr.open(method, url, true)\n    } else if (typeof XDomainRequest !== 'undefined') {\n      // Otherwise, check if XDomainRequest.\n      // XDomainRequest only exists in IE, and is IE's way of making CORS requests.\n      xhr = new XDomainRequest()\n      xhr.open(method, url)\n    } else {\n      // Otherwise, CORS is not supported by the browser.\n      xhr = null\n    }\n    return xhr\n  }\n\n  function clickSubmit () {\n    console.log('clickSubmit enter')\n    const requiredFields = [ '_key_type_of_initiative', '_key_name', '_geometry_lat', '_geometry_lon', '_key_SSEDAS_PARTNER' ]\n    for (var i = 0; i < requiredFields.length; i++) {\n      var id = requiredFields[i]\n      var value = document.getElementById(id).value\n      if (!value || !value.length) {\n        console.error('submit: field ' + id + ' empty')\n        alert('Error on submit: field ' + id.replace(/^_key_/, '') + ' is not allowed to be empty')\n        return false\n      }\n    }\n\n    var data = {\n      'type': 'Feature',\n      'properties': {\n      },\n      'geometry': {\n        'type': 'Point',\n        'coordinates': [\n          parseFloat(document.getElementById('_geometry_lon').value),\n          parseFloat(document.getElementById('_geometry_lat').value)\n        ]\n      }\n    }\n\n    // all 'input type=text'\n    var allInputs = document.getElementsByTagName('input')\n    var freeTags = { keys: {}, values: {} }\n\n    console.log(allInputs)\n\n    for (var i = 0; i < allInputs.length; i++) {\n      var element = allInputs[i]\n      if (!element.type === 'text') {\n        continue\n      }\n      if (element.value && element.id) {\n        console.log(element.id + ': ' + element.value)\n        if (/^_key_/.test(element.id)) {\n          var key = element.id.replace(/^_key_/, '')\n          data.properties[key] = element.value.trim()\n       // element of 'free tags'\n        } else if (/^key[0-9]+$/.test(element.id) && element.name === 'freetags') {\n          var nr = element.id.replace(/^key/, '')\n          freeTags.keys[nr] = element.value\n        } else if (/^value[0-9]+$/.test(element.id) && element.name === 'freetags') {\n          var nr = element.id.replace(/^value/, '')\n          freeTags.values[nr] = element.value\n        }\n      }\n    }\n    console.log(freeTags)\n\n    for (var keynr in freeTags.keys) {\n      var key = freeTags.keys[keynr].trim()\n      if (key && freeTags.values[keynr]) { // only take if key and value are not \"\"\n        data.properties[key] = freeTags.values[keynr].trim()\n      }\n    }\n\n    // drop-down\n    var allSelects = document.getElementsByTagName('select')\n    for (var i = 0; i < allSelects.length; i++) {\n      var element = allSelects[i]\n      if (/^_key_/.test(element.id) && element.value) {\n        var key = element.id.replace(/^_key_/, '')\n\n        for (var childCounter = 0; childCounter < element.children.length; childCounter++) {\n          var child = element.children[childCounter]\n          if (child.selected === true) {\n            data.properties[key] = (data.properties[key] ? (data.properties[key] + ';') : '') + child.value\n          }\n        }\n      }\n    }\n\n    // textarea\n    var allTextareas = document.getElementsByTagName('textarea')\n    for (var i = 0; i < allTextareas.length; i++) {\n      var element = allTextareas[i]\n      if (/^_key_/.test(element.id) && element.value) {\n        var key = element.id.replace(/^_key_/, '')\n        data.properties[key] = element.value.trim()\n      }\n    }\n\n    console.log(data)\n\n    const uuid = document.getElementById('_id').value\n    const sendData = JSON.stringify(data)\n    console.log(sendData)\n\n    // PUT is for UPDATE, POST is for CREATE\n    var xhr = createCORSRequest(uuid ? 'PUT' : 'POST', endpoint + uuid)\n    xhr.setRequestHeader('Content-Type', 'application/json')\n    xhr.send(sendData)\n    console.log(xhr)\n\n    xhr.onreadystatechange = function () {\n      if (xhr.readyState === 4) {\n        if (xhr.status === 200) {\n          var retJson = JSON.parse(xhr.responseText)\n          console.log(retJson)\n          if(retJson.id) {\n            document.getElementById('_id').value = retJson.id\n            alert('Save successful')\n          } else {\n            alert('Error: something wrent wrong on saving: ' + JSON.stringify(retJson) )\n          }\n        } else {\n          console.error(xhr)\n        }\n      }\n    }\n    document.getElementById('deleted').style.display = 'none'\n  }\n  document.getElementById('save').onclick = clickSubmit\n\n  function clickDelete () {\n    const uuid = document.getElementById('_id').value\n    if (!uuid) {\n      alert('nothing to delete')\n      return\n    }\n    if(!confirm('Do you really want to delete this POI? It will be only marked as deleted and can be restored later if you save the current Browser URL.')) {\n      console.log('user aborted delete')\n      return\n    }\n    var xhr = createCORSRequest('DELETE', endpoint + uuid)\n    xhr.send()\n    console.log(xhr)\n\n    xhr.onreadystatechange = function () {\n      if (xhr.readyState === 4) {\n        if (xhr.status === 200) {\n          var retJson = JSON.parse(xhr.responseText)\n          console.log(retJson)\n        } else {\n          console.error(xhr)\n        }\n      }\n    }\n    document.getElementById('deleted').style.display = 'block'\n  }\n  document.getElementById('delete').onclick = clickDelete\n  document.getElementById('plus').onclick = addFreeTagsRow\n\n  function clickSearch () {\n    const country = document.getElementById('_key_addr:country').value\n    const city = document.getElementById('_key_addr:city').value\n    // const postcode = document.getElementById('_key_addr:postcode').value // postcode not used in nominatim, decreases result quality\n    const street = document.getElementById('_key_addr:street').value\n    const housenumber = document.getElementById('_key_addr:housenumber').value\n\n    var querystring = 'q='\n    if (street) {\n      if (housenumber) {\n        querystring += housenumber + '+'\n      }\n      querystring += street + ','\n    }\n    if (city) {\n      querystring += city + ','\n    }\n    querystring += country\n\n    var query = '//nominatim.openstreetmap.org/search?' + querystring + '&format=json&limit=1&email=mapping@transformap.co'\n    console.log(query)\n\n    redFetch([ query ],\n        function (successData) {\n          console.log(successData)\n          if (successData.length !== 1) {\n            console.error('error in Nominatim return data: length != 1')\n            alert('Sorry, Nothing found')\n            return\n          }\n          var result = successData[0]\n          if (result.class === 'building' ||\n              result.class === 'amenity' ||\n              result.class === 'shop' ||\n              (result.class === 'place' && result.type === 'house')\n            ) {\n            console.log('address found exactly')\n            document.getElementById('_geometry_lon').value = result.lon\n            document.getElementById('_geometry_lat').value = result.lat\n\n            // trigger update of place marker\n            document.getElementById('_geometry_lat').focus()\n            document.getElementById('_geometry_lon').focus()\n            map.setView(new L.LatLng(result.lat, result.lon), 18)\n          } else {\n            map.setView(new L.LatLng(result.lat, result.lon), 18)\n            console.log('address not found exactly')\n            setTimeout(function () { // wait for map to pan to location\n              alert('Attention: The address was not found exactly, please place the marker manually!')\n              document.getElementById('_geometry_lon').value = ''\n              document.getElementById('_geometry_lat').value = ''\n              document.getElementById('_geometry_lon').focus()\n              document.getElementById('_geometry_lat').focus()\n            }, 400)\n          }\n        },\n        function (error) {\n          console.log(error)\n          alert('Sorry, Address search did not work')\n        }\n        )\n  }\n  document.getElementById('coordsearch').onclick = clickSearch\n\n function stopRKey(evt) {\n    var evt = (evt) ? evt : ((event) ? event : null)\n    var node = (evt.target) ? evt.target : ((evt.srcElement) ? evt.srcElement : null)\n    if ((evt.keyCode == 13) && (node.type == 'text')) {\n      return false\n    } \n  }\n  document.onkeypress = stopRKey\n\n  function updateLinkPosition() {\n    var centre = map.getCenter()\n    var targetlocation = '#' + map.getZoom() + '/' + centre.lat + '/' + centre.lng\n\n    var maplink = document.getElementById('gotomap')\n    var href = maplink.getAttribute ('href')\n    var splitstr = href.split('#')\n    href = maplink.getAttribute ('href').split('#')[0] + targetlocation\n    maplink.setAttribute('href',href);\n\n    var newlink = document.getElementById('newbutton')\n    newlink.setAttribute('href','./' + targetlocation)\n\n\n  }\n  map.on('moveend', updateLinkPosition);\n\n  console.log('editor initialize end')\n}\n","/*\n * This library provides a simple function to parse URL parameters\n *\n * Mon  3 Oct 15:07:12 CEST 2016\n * Michael Maier (species@github), WTFPL\n *\n * returns object with key:value pairs\n\n This program is free software. It comes without any warranty, to\n     * the extent permitted by applicable law. You can redistribute it\n     * and/or modify it under the terms of the Do What The Fuck You Want\n     * To Public License, Version 2, as published by Sam Hocevar. See\n     * http://www.wtfpl.net/ for more details. */\n\nfunction getUrlVars () {\n  var vars = {}\n  var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function (m, key, value) {\n    vars[key] = value.replace(/#.*$/, '')\n  })\n  return vars\n}\n\nmodule.exports = getUrlVars\n","const L = require('leaflet')\nconst L_Hash = require('leaflet-hash')\nconst L_Draw = require('leaflet-draw')\n\nvar editableLayers\nvar drawControl\nvar placeMarker\nvar popupText = 'Press the edit button to move me. <img style=\"width:30px;height:30px;background-position:-150px -1px;background-image:url(\\'images/spritesheet.svg\\');background-size: 270px 30px;\"> <br><br> Find it on the bottom left corner of the map.'\n\nfunction getDrawControl (allowNewMarker) {\n  var markerValue = allowNewMarker ? { icon: new placeMarker() } : false\n  var options = {\n    position: 'bottomleft',\n    draw: {\n      polyline: false,\n      polygon: false,\n      rectangle: false,\n      circle: false,\n      marker: markerValue\n    },\n    edit: {\n      featureGroup: editableLayers, // REQUIRED!!\n      remove: false\n    }\n  }\n  return new L.Control.Draw(options)\n}\n\nfunction initMap () {\n  console.log('initMap start')\n  var map\n\n  var attrOsm = 'Map data by <a href=\"https://openstreetmap.org\">OpenStreetMap</a> contributors, under <a href=\"https://www.openstreetmap.org/copyright\">ODbL</a>. '\n  var attrPois = 'POIs by <a href=\"http://solidariteconomy.eu\">SUSY</a>, <a href=\"https://creativecommons.org/publicdomain/zero/1.0/\">CC-0</a>. '\n  var leafletBgMaps\n  var zoom\n  var defaultlayer\n  var center\n  var baseMaps = {}\n\n  baseMaps['mapnik'] = new L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n    attribution: attrOsm + attrPois,\n    maxZoom: 19,\n    noWrap: true\n  })\n  baseMaps['stamen_terrain'] = new L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}.png', {\n    attribution: 'Map tiles by <a href=\"http://stamen.com/\">Stamen Design</a>, ' +\n        'under <a href=\"https://creativecommons.org/licenses/by/3.0\">CC BY 3.0</a>. ' +\n        attrOsm + attrPois,\n    maxZoom: 18,\n    noWrap: true\n  })\n  baseMaps['stamen_terrain_bg'] = new L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain-background/{z}/{x}/{y}.png', {\n    attribution: 'Map tiles by <a href=\"http://stamen.com/\">Stamen Design</a>, ' +\n        'under <a href=\"https://creativecommons.org/licenses/by/3.0\">CC BY 3.0</a>. ' +\n        attrOsm + attrPois,\n    maxZoom: 18,\n    noWrap: true\n  })\n  baseMaps['hot'] = new L.tileLayer('http://tile-{s}.openstreetmap.fr/hot/{z}/{x}/{y}.png', {\n    attribution: 'Tiles courtesy of <a href=\"http://hot.openstreetmap.org/\">Humanitarian OpenStreetMap Team</a>. ' +\n        attrOsm + attrPois,\n    maxZoom: 20,\n    noWrap: true\n  })\n\n  if (!leafletBgMaps) {\n    leafletBgMaps = {\n      'Stamen - Terrain': baseMaps['stamen_terrain'],\n      'Stamen - Terrain Background': baseMaps['stamen_terrain_bg'],\n      'OpenStreetMap - Mapnik': baseMaps['mapnik'],\n      'Humanitarian OpenStreetMap ': baseMaps['hot']\n    }\n  }\n  if (!defaultlayer) {\n    defaultlayer = baseMaps['mapnik']\n  }\n\n  map = L.map('map', {\n    zoomControl: true,\n    center: center ? center : new L.LatLng(28.6, 9),\n    zoom: zoom ? zoom : 2,\n    layers: defaultlayer\n  })\n\n  const ctrl = new L.Control.Layers(leafletBgMaps)\n  map.addControl(ctrl)\n  var hash = new L.Hash(map) // Leaflet persistent Url Hash function\n\n  // leaflet draw\n  editableLayers = new L.FeatureGroup()\n  map.addLayer(editableLayers)\n  placeMarker = L.Icon.extend({\n    options: {\n      shadowUrl: null,\n      iconAnchor: new L.Point(12, 40),\n      iconSize: new L.Point(25, 40),\n      iconUrl: 'marker-green.png'\n    }\n  })\n\n  map.on(L.Draw.Event.CREATED, function (e) {\n    var type = e.layerType\n    var layer = e.layer\n\n    if (type === 'marker') {\n      layer.bindPopup(popupText)\n    }\n\n    editableLayers.addLayer(layer)\n    map.my_current_marker = layer\n    document.getElementById('_geometry_lon').value = layer._latlng.lng.toFixed(6)\n    document.getElementById('_geometry_lat').value = layer._latlng.lat.toFixed(6)\n\n    map.removeControl(map.my_drawControl)\n    map.my_drawControl = getDrawControl(false) // deactivate \"add marker\" after the 1st one\n    map.addControl(map.my_drawControl)\n      // fixme instantly enable 'edit' mode of layer\n  })\n\n  map.on('draw:editmove', function (e) {\n    console.log('editmove')\n    console.log(e)\n    document.getElementById('_geometry_lon').value = e.layer._latlng.lng.toFixed(6)\n    document.getElementById('_geometry_lat').value = e.layer._latlng.lat.toFixed(6)\n  })\n\n  map.my_editableLayers = editableLayers\n // map.my_drawControl = drawControl\n  map.my_placeMarker = placeMarker\n  map.getDrawControl = getDrawControl\n\n  map.updateMarkerFromForm = function () {\n    const lat = document.getElementById('_geometry_lat').value\n    const lon = document.getElementById('_geometry_lon').value\n    console.log('new lat: ' + lat + ' lon: ' + lon)\n\n    if (lat && lon) {\n      const coords = L.latLng(lat, lon)\n      if(map.my_current_marker) {\n        map.my_current_marker.setLatLng(coords)\n      } else {\n        map.my_current_marker = new L.marker([lat, lon], { icon: new map.my_placeMarker() })\n        map.my_current_marker.bindPopup(popupText)\n        map.my_editableLayers.addLayer(map.my_current_marker)\n        map.removeControl(map.my_drawControl)\n        map.my_drawControl = getDrawControl(false)\n        map.addControl(map.my_drawControl)\n      }\n         \n      map.panTo(coords)\n    }\n    else\n    {\n      //delete marker\n      console.log('no coords, remove marker')\n      map.my_current_marker.remove()\n      delete(map.my_current_marker)\n      map.removeControl(map.my_drawControl)\n      map.my_drawControl = getDrawControl(true) // allow \"add marker\" again\n      map.addControl(map.my_drawControl)\n    }\n  }\n  document.getElementById('_geometry_lat').onblur = map.updateMarkerFromForm\n  document.getElementById('_geometry_lon').onblur = map.updateMarkerFromForm\n\n  // console.log(map)\n\n  console.log('initMap end')\n  return map\n}\n\nmodule.exports = initMap\n","/*\n * This library provides a 'fetch', where you can use fallback URIs, to build on redundant servers.\n *\n * Mon  3 Oct 15:07:12 CEST 2016\n * Michael Maier (species@github), WTFPL\n *\n * Give it an array of resources, that can be fetched from different urls.\n * Will try to fetch them in the provided order.\n * Execute success_function on the first successful fetch, and error_function only if all resources fail to fetch.\n */\n\n/* This program is free software. It comes without any warranty, to\n     * the extent permitted by applicable law. You can redistribute it\n     * and/or modify it under the terms of the Do What The Fuck You Want\n     * To Public License, Version 2, as published by Sam Hocevar. See\n     * http://www.wtfpl.net/ for more details. */\n\n/* new version of getting map data with promises\n\n  taken from https://blog.hospodarets.com/fetch_in_action\n*/\n\nvar processStatus = function (response) {\n    // status \"0\" to handle local files fetching (e.g. Cordova/Phonegap etc.)\n  if (response.status === 200 || response.status === 0) {\n    return Promise.resolve(response)\n  } else {\n    return Promise.reject(new Error(response.statusText))\n  }\n}\n\nvar parseJson = function (response) {\n  return response.json()\n}\n\n/* @returns {wrapped Promise} with .resolve/.reject/.catch methods */\n// It goes against Promise concept to not have external access to .resolve/.reject methods, but provides more flexibility\nvar getWrappedPromise = function () {\n  var wrappedPromise = {}\n  var promise = new Promise(function (resolve, reject) {\n    wrappedPromise.resolve = resolve\n    wrappedPromise.reject = reject\n  })\n  wrappedPromise.then = promise.then.bind(promise)\n  wrappedPromise.catch = promise.catch.bind(promise)\n  wrappedPromise.promise = promise// e.g. if you want to provide somewhere only promise, without .resolve/.reject/.catch methods\n  return wrappedPromise\n}\n\n/* @returns {wrapped Promise} with .resolve/.reject/.catch methods */\nvar getWrappedFetch = function () {\n  var wrappedPromise = getWrappedPromise()\n  var args = Array.prototype.slice.call(arguments)// arguments to Array\n\n  window.fetch.apply(null, args)// calling original fetch() method\n        .then(function (response) {\n          wrappedPromise.resolve(response)\n        }, function (error) {\n          wrappedPromise.reject(error)\n        })\n        .catch(function (error) {\n          wrappedPromise.catch(error)\n        })\n  return wrappedPromise\n}\n\n/**\n * Fetch JSON by url\n * @param { {\n *  url: {String},\n *  [cacheBusting]: {Boolean}\n * } } params\n * @returns {Promise}\n*/var MAX_WAITING_TIME = 5000// in ms\n\nvar getJSON = function (params) {\n  var wrappedFetch = getWrappedFetch(\n        params.cacheBusting ? params.url + '?' + new Date().getTime() : params.url,\n    {\n      method: 'get', // optional, \"GET\" is default value\n      headers: {\n        'Accept': 'application/json'\n      }\n    })\n\n  var timeoutId = setTimeout(function () {\n    wrappedFetch.reject(new Error('Load timeout for resource: ' + params.url))// reject on timeout\n  }, MAX_WAITING_TIME)\n\n  return wrappedFetch.promise// getting clear promise from wrapped\n        .then(function (response) {\n          clearTimeout(timeoutId)\n          return response\n        })\n        .then(processStatus)\n        .then(parseJson)\n}\n\nfunction myGetJSON (url, successFunction, errorFunction) {\n  var getJSONparams = { url: url, cacheBusting: true }\n\n  getJSON(getJSONparams).then(\n    function (data) { successFunction(data) },\n    function (error) { errorFunction(error) }\n  )\n}\n\nfunction redundantFetch (dataUrlArray, successFunction, errorFunction) {\n  if (!(!!dataUrlArray && Array === dataUrlArray.constructor)) {\n    console.error('redundantFetch: argument is no array')\n    console.error(dataUrlArray)\n    return false\n  }\n  var currentUrl = dataUrlArray[0]\n  if (typeof (currentUrl) !== 'string') {\n    console.error('redundantFetch: url is no string')\n    return false\n  }\n\n  console.log('redundantFetch called, urls:')\n  console.log(dataUrlArray)\n\n  dataUrlArray.shift()\n\n  var localErrorFunction\n  var localSuccessFunction\n  if (dataUrlArray.length == 0) { // last iteration\n    localSuccessFunction = successFunction\n    localErrorFunction = errorFunction\n  } else {\n    localSuccessFunction = successFunction\n    localErrorFunction = function (error) {\n      redundantFetch(dataUrlArray, successFunction, errorFunction)\n    }\n  }\n\n  var getJSONparams = { url: currentUrl, cacheBusting: true }\n  getJSON(getJSONparams).then(\n    function (data) { localSuccessFunction(data); console.log('rfetch: success on '); console.log(data) },\n    function (error) { localErrorFunction(error); console.log('rfetch: fail on '); console.log(error) }\n  )\n}\n\nmodule.exports = redundantFetch\n","/*\n * This library handles taxonomy related stuff for the transformap editor\n *\n * Mon  3 Oct 15:07:12 CEST 2016\n * Michael Maier (species@github), WTFPL\n\n * This program is free software. It comes without any warranty, to\n * the extent permitted by applicable law. You can redistribute it\n * and/or modify it under the terms of the Do What The Fuck You Want\n * To Public License, Version 2, as published by Sam Hocevar. See\n * http://www.wtfpl.net/ for more details. */\n\nfunction getLangTaxURL (lang) {\n  if (!lang) {\n    console.error('setFilterLang: no lang given')\n    return false\n  }\n\n  var tax_query =\n    'prefix bd: <http://www.bigdata.com/rdf#> ' +\n    'prefix wikibase: <http://wikiba.se/ontology#> ' +\n    'prefix wdt: <http://base.transformap.co/prop/direct/>' +\n    'prefix wd: <http://base.transformap.co/entity/>' +\n    'SELECT ?item ?itemLabel ?instance_of ?subclass_of ?type_of_initiative_tag ?wikipedia ?description ' +\n    'WHERE {' +\n      '?item wdt:P8* wd:Q8 .' +\n      '?item wdt:P8 ?subclass_of .' +\n      'OPTIONAL { ?item wdt:P4 ?instance_of . }' +\n      'OPTIONAL { ?item wdt:P15 ?type_of_initiative_tag }' +\n      'OPTIONAL { ?item schema:description ?description FILTER(LANG(?description) = \"' + lang + '\") }' +\n      'OPTIONAL { ?wikipedia schema:about ?item . ?wikipedia schema:inLanguage \"en\"}' +\n      'SERVICE wikibase:label {bd:serviceParam wikibase:language \"' + lang + '\" }' +\n    '}'\n\n  return 'https://query.base.transformap.co/bigdata/namespace/transformap/sparql?query=' + encodeURIComponent(tax_query) + '&format=json'\n}\n\nmodule.exports = {\n  getLangTaxURL: getLangTaxURL\n}\n","// mostly taken from https://github.com/TransforMap/transformap-viewer/blob/gh-pages/scripts/map.js\n\nfunction getLangs () {\n  var language = window.navigator.languages ? window.navigator.languages[0] : (window.navigator.language || window.navigator.userLanguage);\n\n  if(typeof language === 'string')\n      language = [ language ];\n\n  // we need to have the following languages:\n  // browserlang\n  // a short one (de instead of de-AT) if not present\n  // en as fallback if not present\n\n  for(var i = 0; i < language.length; i++) {\n      if(language[i].match(/-/)) {\n          var short_lang = language[i].match(/^([a-zA-Z]*)-/)[1];\n          if(language.indexOf(short_lang) == -1) {\n              language.push(short_lang);\n              continue;\n          }\n      }\n  }\n\n  if(language.indexOf(\"en\") == -1)\n      language.push(\"en\");\n\n  console.log(language);\n  return language;\n}\n\nfunction setFallbackLangs() {\n  fallback_langs = [];\n  if(current_lang != \"en\") {\n    for(var i=0; i < browser_languages.length; i++) {\n      var abbr = browser_languages[i];\n      if(current_lang != abbr)\n        fallback_langs.push(abbr);\n    }\n  }\n  console.log(\"new fallback langs: \" + fallback_langs.join(\",\") + \".\");\n}\n\nfunction resetLang() {\n  current_lang = \"en\";\n  for(var i=0; i < browser_languages.length; i++) {\n    var abbr = browser_languages[i];\n    if(abbr_langnames[abbr]) {\n      current_lang = abbr;\n      break;\n    }\n  }\n  switchToLang(current_lang);\n}\n\n/* get languages for UI from our Wikibase, and pick languages that are translated there */\n\nvar supported_languages = [],\n    langnames = [],\n    abbr_langnames = {},\n    langnames_abbr = {};\nfunction initializeLanguageSwitcher(returned_data){\n  var lang;\n  for(lang in returned_data.entities.Q5.labels) { //Q5 is arbitrary. Choose one that gets translated for sure.\n    supported_languages.push(lang);\n  }\n  var langstr = supported_languages.join(\"|\");\n  \n  var langstr_query =\n    'SELECT ?lang ?langLabel ?abbr ' +\n    'WHERE' +\n    '{' +\n      '?lang wdt:P218 ?abbr;' +\n      'FILTER regex (?abbr, \"^('+langstr+')$\").' +\n      'SERVICE wikibase:label { bd:serviceParam wikibase:language \"en\". }' +\n    '}';\n  \n  langstr_query = 'https://query.wikidata.org/bigdata/namespace/wdq/sparql?query=' +encodeURIComponent(langstr_query) + \"&format=json\";\n  $.getJSON(langstr_query, function (langstrings){\n    \n    langstrings.results.bindings.forEach(function (item) {\n      abbr_langnames[item.abbr.value] = item.langLabel.value;\n      langnames_abbr[item.langLabel.value] = item.abbr.value;\n      langnames.push(item.langLabel.value);\n    });\n    langnames.sort();\n    \n    resetLang();\n    setFallbackLangs();\n    \n    langnames.forEach(function (item) {\n      var langcode = langnames_abbr[item];\n      var is_default = (langcode == current_lang) ? \" class=default\" : \"\";\n      console.log(\"adding lang '\" + langcode + \"' (\" + item + \")\"); \n      $(\"#languageSelector ul\").append(\"<li targetlang=\" + langcode + is_default + \" onClick='window.translations.switchToLang(\\\"\"+langcode+\"\\\");'>\"+item+\"</li>\");\n    });\n  });\n}\n\nfunction switchToLang(lang) {\n  $(\"#languageSelector li.default\").removeClass(\"default\");\n  $(\"#languageSelector li[targetlang=\"+lang+\"]\").addClass(\"default\");\n  current_lang = lang;\n  window.translations.current_lang = lang;\n  window.translations.fetchAndSetNewTranslation(lang);\n  setFallbackLangs();\n/*\n  //updateTranslatedTexts();\n\n  if(! dictionary[lang]) {\n    var dict_uri = \"https://raw.githubusercontent.com/TransforMap/transformap-viewer-translations/master/json/\"+lang+\".json\";\n\n    $.ajax({\n      url: dict_uri,\n      context: { lang: current_lang },\n      success: function(returned_data) {\n        var trans_jsonobj = JSON.parse(returned_data);\n\n        if(! dictionary[this.lang])\n          dictionary[this.lang] = {};\n        for (item in trans_jsonobj) {\n          var index = reverse_dic[item];\n          dictionary[this.lang][index] = trans_jsonobj[item];\n        }\n\n        console.log(\"successfully fetched \" + this.lang);\n        //updateTranslatedTexts();\n\n      }\n    });\n\n  }\n\n  // As rebuilding the filters does not yet support advanced mode by default,\n  // we switch to simple mode, as language switching is a very rare case.\n  if(getFilterMode() == \"advanced\")\n    toggleAdvancedFilterMode();\n\n  resetFilter();\n  setFilterLang(lang);\n*/\n  console.log(\"new lang:\" +lang);\n}\n\n// if wishedLang is in supported, OK\n// shorten wishedLang and see if in supported\n// take fallback\nfunction selectAllowedLang(wishedLang) {\n  console.log(\"selectAllowedLang(\" + wishedLang + \") called\")\n  if(wishedLang) {\n    if(supported_languages.indexOf(wishedLang) != -1) {\n      current_lang = wishedLang\n      return current_lang\n    }\n    console.log(\"not in supported, try shorten\")\n    var matches = wishedLang.match(/^([a-zA-Z]*)-/)\n    if(matches && matches[1]) {\n      var short_lang = matches[1];\n      console.log(\"short: \" + short_lang)\n      if(short_lang) {\n        if(supported_languages.indexOf(short_lang) != -1) {\n          current_lang = short_lang\n          console.log(\"current_lang set to \" + short_lang)\n          return current_lang\n        }\n      }\n    }\n  }\n  setFallbackLangs()\n  if(fallback_langs[0]) {\n    if(supported_languages.indexOf(fallback_langs[0]) != -1) {\n      current_lang = fallback_langs[0]\n      return current_lang\n    }\n  }\n  current_lang = 'en'\n  return current_lang\n}\n\nvar browser_languages = getLangs(),\n    current_lang = browser_languages[0],\n    fallback_langs = [];\n\nmodule.exports = {\n  getLangs: getLangs,\n  initializeLanguageSwitcher: initializeLanguageSwitcher,\n  supported_languages: supported_languages,\n  browser_languages: browser_languages,\n  current_lang: current_lang,\n  switchToLang: switchToLang,\n  selectAllowedLang: selectAllowedLang\n}\n"]}